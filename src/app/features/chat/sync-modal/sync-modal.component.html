<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" (click)="close.emit()">
  <div class="bg-gray-800 rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="p-6 border-b border-gray-700">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">üîó Sincronizaci√≥n P2P</h2>
        <button (click)="close.emit()" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">‚úï</button>
      </div>
      <p class="text-sm text-gray-400 mt-2">
        Conecta dispositivos en tu red local para inferencia distribuida
      </p>
    </div>

    <!-- Server Config -->
    <div class="px-6 py-4 bg-gray-700/30 border-b border-gray-700">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1">
          <p class="text-xs text-gray-400">Servidor de se√±alizaci√≥n</p>
          @if (editingServer()) {
            <div class="flex items-center gap-2 mt-1">
              <input
                type="text"
                [ngModel]="newServerUrl()"
                (ngModelChange)="newServerUrl.set($event)"
                placeholder="ws://192.168.1.x:8080"
                class="flex-1 px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm focus:outline-none focus:border-blue-500"
              />
              <button (click)="saveServer()" class="text-green-400 hover:text-green-300">‚úì</button>
              <button (click)="editingServer.set(false)" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
          } @else {
            <p class="text-sm font-mono flex items-center gap-2">
              {{ serverUrl() }}
              @if (connectionMode() === 'disconnected') {
                <button (click)="startEditServer()" class="text-gray-400 hover:text-white text-xs">‚úèÔ∏è</button>
              }
            </p>
          }
        </div>
        <div>
          @if (connectionMode() === 'disconnected') {
            <button
              (click)="connectToServer()"
              [disabled]="isConnecting()"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm transition-colors disabled:opacity-50">
              @if (isConnecting()) {
                Conectando...
              } @else {
                Conectar
              }
            </button>
          } @else {
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              <span class="text-sm text-green-400">Conectado</span>
            </div>
          }
        </div>
      </div>

      @if (error()) {
        <div class="mt-2 p-2 bg-red-600/20 border border-red-600/30 rounded-lg text-sm text-red-400">
          {{ error() }}
        </div>
      }
    </div>


    @if (connectionMode() === 'connected') {
      <!-- Device Info -->
      <div class="px-6 py-3 bg-gray-700/20 border-b border-gray-700">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-400">Este dispositivo</p>
            @if (editingName()) {
              <div class="flex items-center gap-2 mt-1">
                <input
                  type="text"
                  [ngModel]="newDeviceName()"
                  (ngModelChange)="newDeviceName.set($event)"
                  class="px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm focus:outline-none focus:border-blue-500"
                />
                <button (click)="saveName()" class="text-green-400 hover:text-green-300">‚úì</button>
              </div>
            } @else {
              <p class="font-medium flex items-center gap-2">
                {{ deviceInfo.name }}
                <button (click)="startEditName()" class="text-gray-400 hover:text-white text-xs">‚úèÔ∏è</button>
              </p>
            }
          </div>

          @if (syncToken()) {
            <div class="text-right">
              <p class="text-xs text-gray-400">Sala activa</p>
              <div class="flex items-center gap-2">
                <code class="font-mono text-lg text-green-400">{{ syncToken() }}</code>
                <button (click)="copyToken()" class="text-gray-400 hover:text-white" title="Copiar">üìã</button>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-gray-700">
        <button
          (click)="activeTab.set('connect')"
          class="flex-1 px-4 py-3 text-sm font-medium transition-colors"
          [class.text-blue-400]="activeTab() === 'connect'"
          [class.border-b-2]="activeTab() === 'connect'"
          [class.border-blue-400]="activeTab() === 'connect'"
          [class.text-gray-400]="activeTab() !== 'connect'">
          üöÄ Conectar
        </button>
        <button
          (click)="activeTab.set('peers')"
          class="flex-1 px-4 py-3 text-sm font-medium transition-colors relative"
          [class.text-blue-400]="activeTab() === 'peers'"
          [class.border-b-2]="activeTab() === 'peers'"
          [class.border-blue-400]="activeTab() === 'peers'"
          [class.text-gray-400]="activeTab() !== 'peers'">
          üë• Peers ({{ connectedPeers().length }})
        </button>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-4">
        @if (activeTab() === 'connect') {
          @if (!syncToken()) {
            <!-- Create or Join Room -->
            <div class="space-y-4">
              <div class="p-4 bg-gray-700/50 rounded-xl">
                <h3 class="font-medium mb-2">Crear nueva sala</h3>
                <p class="text-sm text-gray-400 mb-3">
                  Genera un c√≥digo para que otros dispositivos se unan
                </p>
                <button
                  (click)="createRoom()"
                  class="w-full px-4 py-3 bg-green-600 hover:bg-green-500 rounded-xl font-medium transition-colors">
                  ‚ûï Crear Sala
                </button>
              </div>

              <div class="text-center text-gray-500 text-sm">‚Äî o ‚Äî</div>

              <div class="p-4 bg-gray-700/50 rounded-xl">
                <h3 class="font-medium mb-2">Unirse a sala existente</h3>
                <p class="text-sm text-gray-400 mb-3">
                  Ingresa el c√≥digo de la sala
                </p>
                <div class="flex gap-2">
                  <input
                    type="text"
                    [ngModel]="joinToken()"
                    (ngModelChange)="joinToken.set($event.toUpperCase())"
                    placeholder="ABC123"
                    maxlength="8"
                    class="flex-1 px-4 py-3 bg-gray-600 border border-gray-500 rounded-xl text-center font-mono text-lg uppercase tracking-widest focus:outline-none focus:border-blue-500"
                  />
                  <button
                    (click)="joinRoom()"
                    [disabled]="joinToken().length < 4"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Unirse
                  </button>
                </div>
              </div>
            </div>
          } @else {
            <!-- Room Active -->
            <div class="text-center py-6">
              <div class="text-6xl mb-4">üéâ</div>
              <h3 class="text-xl font-semibold mb-2">Sala Activa</h3>
              <p class="text-gray-400 mb-4">
                Comparte este c√≥digo con otros dispositivos:
              </p>
              <div class="inline-flex items-center gap-3 px-6 py-4 bg-gray-700 rounded-2xl">
                <code class="font-mono text-3xl text-green-400 tracking-widest">{{ syncToken() }}</code>
                <button (click)="copyToken()" class="p-2 hover:bg-gray-600 rounded-lg transition-colors" title="Copiar">
                  üìã
                </button>
              </div>
              <p class="text-sm text-gray-500 mt-4">
                {{ connectedPeers().length }} dispositivo(s) conectado(s)
              </p>
              <button
                (click)="leaveRoom()"
                class="mt-6 px-4 py-2 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded-lg text-sm transition-colors">
                Salir de la sala
              </button>
            </div>
          }
        }


        @if (activeTab() === 'peers') {
          <div class="space-y-2">
            @for (peer of peers(); track peer.id) {
              <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-xl">
                <div class="flex items-center gap-3">
                  <span class="w-3 h-3 rounded-full" [class]="getStatusColor(peer.status)"></span>
                  <div>
                    <p class="font-medium">{{ peer.name }}</p>
                    <p class="text-xs text-gray-400">{{ getStatusText(peer.status) }}</p>
                  </div>
                </div>
                @if (peer.status === 'connected') {
                  <span class="text-green-400 text-sm">‚úì P2P</span>
                }
              </div>
            }

            @if (peers().length === 0) {
              <div class="text-center py-8 text-gray-500">
                <p class="text-4xl mb-2">üë•</p>
                <p>No hay peers en la sala</p>
                <p class="text-xs mt-1">Comparte el c√≥digo para que otros se unan</p>
              </div>
            }
          </div>
        }
      </div>
    } @else {
      <!-- Not Connected -->
      <div class="flex-1 flex items-center justify-center p-8">
        <div class="text-center">
          <div class="text-6xl mb-4">üì°</div>
          <h3 class="text-xl font-semibold mb-2">Conecta al servidor</h3>
          <p class="text-gray-400 max-w-sm">
            Primero conecta al servidor de se√±alizaci√≥n para descubrir otros dispositivos en tu red.
          </p>
        </div>
      </div>
    }

    <!-- Footer -->
    <div class="p-4 border-t border-gray-700 text-xs text-gray-500 space-y-1">
      <p>üí° Ejecuta el servidor: <code class="text-blue-400">cd signaling-server && npm start</code></p>
      <p>üîí La comunicaci√≥n de datos es directa P2P (WebRTC) entre navegadores.</p>
    </div>
  </div>
</div>
